<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!--jQuery 로드-->
        <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
        <!--지도 UI CSS 로드-->
        <link rel="stylesheet" href="css/map.css">
        <title>Korea_Polygon</title>
    </head>
    <body>
        <!--KAKAO-MAP 로드-->
        <div id="map" style="width:100%;height:100vh;"></div>
        <script
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2befa4c2ccbf24ac6c3bec24f23abb28"></script>
        <script>
            let map = new kakao
                .maps
                .Map(document.getElementById('map'), {
                    // 지도를 표시할 div
                    center: new kakao
                        .maps
                        .LatLng(37.5642135, 127.0016985), // 초기 지도의 중심좌표
                    level: 8, // 초기 지도의 확대 레벨
                    disableDoubleClickZoom: true, // 지도에 더블클릭 방지
                });
            console.log("초기 지도 줌 레벨 값은 :", map.getLevel());
            // 지도 축소 최대 값 설정
            map.setMaxLevel(12);
            // 지도의 중심좌표 변수
            let mapCenter = map.getCenter();
            // 지도의 타입 변수
            let mapType;
            // 지도의 줌 레벨 변수
            let mapLevel;
            // 지도에 렌더링 된 마커 배열
            let markers = [];

            // 일반 지도와 스카이뷰로 지도 타입을 전환할 수 있는 지도타입 컨트롤을 생성합니다
            let mapTypeControl = new kakao
                .maps
                .MapTypeControl();
            // 지도에 컨트롤을 추가해야 지도위에 표시됩니다 kakao.maps.ControlPosition은 컨트롤이 표시될 위치를 정의하는데
            // TOPRIGHT는 오른쪽 위를 의미합니다
            map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

            // 지도 확대 축소를 제어할 수 있는  줌 컨트롤을 생성합니다
            let zoomControl = new kakao
                .maps
                .ZoomControl();
            map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

            // 초기 지도는 화면 중심으로 시군구 단위로 폴리곤 렌더링
            mapUnit(mapCenter, 'sig', true);

            // 지도에 줌 이벤트가 발생하였을 때
            kakao
                .maps
                .event
                .addListener(map, 'zoom_changed', function () {
                    // 지도의 현재 중심좌표를 얻어옵니다
                    mapCenter = map.getCenter();
                    // 지도의 현재 줌 레벨값을 얻어옵니다
                    mapLevel = map.getLevel();
                    console.log("현재 지도 줌 레벨 값은 :", mapLevel);

                    // 레벨이 10 이상인 경우 시도 단위로 폴리곤 렌더링
                    if (mapLevel >= 10) {
                        deletePolygon(polygons);
                        deleteMarker(markers);
                        mapUnit(mapCenter, 'ctp', true);
                    }
                    // 레벨이 7이상 10미만 경우 시군구 단위로 폴리곤 렌더링
                    if (mapLevel >= 7 && mapLevel < 10) {
                        deletePolygon(polygons);
                        deleteMarker(markers);
                        mapUnit(mapCenter, 'sig', true);
                    }
                    // 레벨이 5이상 7미만 경우 읍면동 단위로 폴리곤 렌더링
                    if (mapLevel >= 5 && mapLevel < 7) {
                        deletePolygon(polygons);
                        deleteMarker(markers);
                        mapUnit(mapCenter, 'emd', true);
                    }
                    //레벨이 4이하 경우 거리 단위 이므로 해당 지역 관련 마커 렌더링
                    if (mapLevel <= 4) {
                        deletePolygon(polygons);
                        deleteMarker(markers);
                        mapUnit(mapCenter, 'emd', false);
                    }
                });

            // 지도에 드래그 이벤트가 발생하였을 때
            kakao
                .maps
                .event
                .addListener(map, 'dragend', function () {
                    mapCenter = map.getCenter();
                    mapLevel = map.getLevel();

                    // 드래그 이벤트로 인한 새로운 지도 모습에 중심좌표를 기점으로 새 폴리곤 및 UI 렌더링
                    if (mapLevel > 4) {
                        deletePolygon(polygons);
                        mapUnit(mapCenter, mapType, true);
                    } else {
                        deleteMarker(markers);
                        mapUnit(mapCenter, 'emd', false);
                    }
                });

            // 지도 타입에 따른 관리자 페이지 API 'geo' 호출 함수
            function mapUnit(mapCenter, map_type, zoomTF) {
                // 사용자 지도 화면 중심 좌표와 검색 범위를 API 요청값으로 넘겨 폴리곤 그리고 UI 렌더링 함수에 이용 
                // 또한, 갑작스런 줌 레벨 변화(ex: ctp -> 거리단위)에 대비해 True/False 문으로 화면 마다의 렌더링 내용을 구분
                if (map_type == "ctp") {
                    $
                        .ajax({
                            method: "GET",
                            dataType: "json",
                            url: "https://foilemap.co.kr/geo",
                            data: {
                                lat: mapCenter.getLat(),
                                lot: mapCenter.getLng(),
                                distance: '200',
                                map: map_type
                            },
                            error: function (e) {
                                console.log('Error:', e);
                            }
                        })
                        .done(function (params) {
                            // console.log(params);
                            let data = params.data;
                            let coordinates = [];
                            let getData = [];
                            let getCD = [];
                            $.each(data, function (index, val) {
                                mapType = val.map_type;
                                coordinates = val.coordinates;
                                getData.push({
                                    center: [
                                        val.center_lat, val.center_lot
                                    ],
                                    name: val.KOR_NM,
                                    cd: val.CD
                                });
                                getCD.push(val.CD);
                                // console.log(coordinates);
                                if (zoomTF) {
                                    display(coordinates);
                                }
                            });
                            // console.log(getData);
                            mapCnt(getCD, getData, zoomTF);
                        });
                } else if (map_type == "sig") {
                    $
                        .ajax({
                            method: "GET",
                            dataType: "json",
                            url: "https://foilemap.co.kr/geo",
                            data: {
                                lat: mapCenter.getLat(),
                                lot: mapCenter.getLng(),
                                distance: '40',
                                map: map_type
                            },
                            error: function (e) {
                                console.log('Error:', e);
                            }
                        })
                        .done(function (params) {
                            // console.log(params);
                            let data = params.data;
                            let coordinates = [];
                            let getData = [];
                            let getCD = [];
                            $.each(data, function (index, val) {
                                mapType = val.map_type;
                                coordinates = val.coordinates;
                                getData.push({
                                    center: [
                                        val.center_lat, val.center_lot
                                    ],
                                    name: val.KOR_NM,
                                    cd: val.CD
                                });
                                getCD.push(val.CD);
                                // console.log(coordinates);
                                if (zoomTF) {
                                    display(coordinates);
                                }
                            });
                            // console.log(getData);
                            mapCnt(getCD, getData, zoomTF);
                        });
                } else if (map_type == "emd") {
                    $
                        .ajax({
                            method: "GET",
                            dataType: "json",
                            url: "https://foilemap.co.kr/geo",
                            data: {
                                lat: mapCenter.getLat(),
                                lot: mapCenter.getLng(),
                                distance: '5',
                                map: map_type
                            },
                            error: function (e) {
                                console.log('Error:', e);
                            }
                        })
                        .done(function (params) {
                            // console.log(params);
                            let data = params.data;
                            let coordinates = [];
                            let getData = [];
                            let getCD = [];
                            $.each(data, function (index, val) {
                                mapType = val.map_type;
                                coordinates = val.coordinates;
                                getData.push({
                                    center: [
                                        val.center_lat, val.center_lot
                                    ],
                                    name: val.KOR_NM,
                                    cd: val.CD
                                });
                                getCD.push(val.CD);
                                // console.log(coordinates);
                                if (zoomTF) {
                                    display(coordinates);
                                }
                            });
                            // console.log(getData);
                            mapCnt(getCD, getData, zoomTF);
                        });
                }
            }

            let polygons = []; // 지도 줌 이벤트 시 폴리곤 제거를 위한 배열
            // 폴리곤 렌더링 함수
            function display(coordinates) {
                let path = [];
                // console.log(coordinates.length);

                $.each(coordinates, function (index, coordinate) {
                    let paths = [];
                    $.each(coordinate, function (index, coord) {
                        paths.push(new kakao.maps.LatLng(coord.lat, coord.lot));
                    });
                    path.push(paths);
                });

                let polygon = new kakao
                    .maps
                    .Polygon({
                        map: map,
                        path: path,
                        strokeWeight: 2,
                        strokeColor: '#004c80',
                        strokeOpacity: 0.8,
                        // strokeStyle: 'dashed',
                        fillColor: '#fff',
                        fillOpacity: 0.3
                    });
                polygons.push(polygon);

                // 다각형에 mouseover 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 변경합니다 지역명을 표시하는 커스텀오버레이를 지도위에
                // 표시합니다
                kakao
                    .maps
                    .event
                    .addListener(polygon, 'mouseover', function () {
                        polygon.setOptions({fillColor: '#09f'});
                    });
                kakao
                    .maps
                    .event
                    .addListener(polygon, 'mouseout', function () {
                        polygon.setOptions({fillColor: '#fff'});
                    });
            };

            // 행정구역 매물 관련 API 'forsale' 호출 함수
            function mapCnt(getCD, getData, zoomTF) {
                // console.log(getCD);
                let CDstring = getCD.join(','); // CD 배열을 문자열로 변환
                $
                    .ajax({
                        method: "POST",
                        dataType: "json",
                        url: "https://foilemap.co.kr/forsale/map",
                        contentType: "application/json",
                        data: JSON.stringify({
                            "lat": mapCenter.getLat(),
                            "lot": mapCenter.getLng(),
                            "distance": 100,
                            "geoCDS": CDstring,
                            "map": mapType,
                            "page": 0,
                            "printSize": 10
                        }),
                        error: function (e) {
                            console.log('Error...', e);
                        }
                    })
                    .done(function (params) {
                        // console.log(params);
                        if (zoomTF) {
                            let arry = [];
                            $.each(params.data, function (index, val) {
                                // console.log(val); 지도의 타입에 따라 해당 매물의 'CD' 값을 구분지어 받음
                                if (mapType == "ctp") {
                                    arry.push({cnt: val.cnt, type: val.addr_CD_1});
                                } else if (mapType == "sig") {
                                    arry.push({cnt: val.cnt, type: val.addr_CD_2});
                                } else if (mapType == "emd") {
                                    arry.push({cnt: val.cnt, type: val.addr_CD_3});
                                }
                            });

                            $.each(getData, function (index, val) {
                                // console.log(val);
                                arry.forEach(element => {
                                    // 매물 cnt 값이 있으며 현재 렌더링 된 폴리곤 범위에 속한 구역이라면
                                    if (element.type == val.cd) {
                                        displayInfo(
                                            new kakao.maps.LatLng(val.center[0], val.center[1]),
                                            val.name,
                                            element.cnt
                                        );
                                    } else {
                                        displayInfo(new kakao.maps.LatLng(val.center[0], val.center[1]), val.name, 0)
                                    }
                                });
                            });
                        } else {
                            // 거리 단위에 해당되는 내용으로 마커 렌더링과 마커 관련 마우스 이벤트를 구현
                            $.each(params.data, function (index, val) {
                                // console.log(val);
                                $
                                    .ajax({
                                        method: "GET",
                                        dataType: "json",
                                        url: "https://foilemap.co.kr/forsaleHeavy/heavy",
                                        data: {
                                            hsid: val.hsid
                                        },
                                        error: function (e) {
                                            console.log('Error:', e);
                                        }
                                    })
                                    .done(function (result) {
                                        console.log(result);
                                        markers = $(result.data).map(function (i, position) {
                                            return new kakao
                                                .maps
                                                .Marker({
                                                    position: new kakao
                                                        .maps
                                                        .LatLng(position.lat, position.lot)
                                                })
                                        });
                                        for (let index = 0; index < markers.length; index++) {
                                            markers[index].setMap(map);
                                            let infowindow = new kakao
                                                .maps
                                                .InfoWindow({
                                                    content: result
                                                        .data[index]
                                                        .houseName // 인포윈도우에 표시할 내용
                                                });
                                            // 마커에 mouseover 이벤트와 mouseout 이벤트를 등록합니다 이벤트 리스너로는 클로저를 만들어 등록합니다 for문에서 클로저를
                                            // 만들어 주지 않으면 마지막 마커에만 이벤트가 등록됩니다
                                            kakao
                                                .maps
                                                .event
                                                .addListener(
                                                    markers[index],
                                                    'mouseover',
                                                    makeOverListener(map, markers[index], infowindow)
                                                );
                                            kakao
                                                .maps
                                                .event
                                                .addListener(markers[index], 'mouseout', makeOutListener(infowindow));
                                            kakao
                                                .maps
                                                .event
                                                .addListener(markers[index], 'click', makeClickListener(result.data[index]));
                                        }
                                    });
                            });
                        }
                    });
            }

            // 행정구역 UI 렌더링 함수
            function displayInfo(center, name, cnt) {
                // console.log(center, name);
                let customOverlay = new kakao
                    .maps
                    .CustomOverlay({}); // 해당 지역 관련 UI를 표시할 오버레이

                let content = document.createElement('div');
                content.className = 'area';
                content.innerHTML = '<span class="text">' + name +
                        '</span><span class="text2">' + cnt + '개</span></div>';
                // console.log(content);
                customOverlay.setContent(content);
                customOverlay.setPosition(center);
                customOverlay.setMap(map);
                addEventHandle(content, 'click', onMouseClick(center));

                // 줌 이벤트, 드래그 이벤트가 있을 때 마다 기존의 UI는 제거
                kakao
                    .maps
                    .event
                    .addListener(map, 'zoom_changed', function () {
                        customOverlay.setMap(null);
                    });
                kakao
                    .maps
                    .event
                    .addListener(map, 'dragend', function () {
                        customOverlay.setMap(null);
                    });
            }

            // 지도 줌 이벤트에 따른 기존 폴리곤 제거
            function deletePolygon(polygons) {
                for (let index = 0; index < polygons.length; index++) {
                    polygons[index].setMap(null);
                }
            }
            // 지도 줌 이벤트에 따른 기존 마커 제거
            function deleteMarker(markers) {
                for (let index = 0; index < markers.length; index++) {
                    markers[index].setMap(null);
                }
            }

            // 마커의 인포윈도우를 표시하는 클로저를 만드는 함수입니다
            function makeOverListener(map, marker, infowindow) {
                return function () {
                    infowindow.open(map, marker);
                };
            }
            // 마커의 인포윈도우를 닫는 클로저를 만드는 함수입니다
            function makeOutListener(infowindow) {
                return function () {
                    infowindow.close();
                };
            }
            // 마커의 인포윈도우를 클릭하는 클로저를 만드는 함수
            function makeClickListener(info) {
                return function () {
                    console.log('클릭된 매물 정보는 : ', info);
                }
            }

            // 행정구역 UI를 클릭 했을 때 호출되는 핸들러 입니다
            function onMouseClick(center) {
                return function () {
                    // console.log('click'); UI 클릭 시 지도 줌 이벤트 활성
                    map.setLevel(map.getLevel() - 2, {
                        anchor: center,
                        animate: {
                            duration: 350
                        }
                    });
                    deletePolygon(polygons);
                };
            }
            // target node에 이벤트 핸들러를 등록하는 함수힙니다
            function addEventHandle(target, type, callback) {
                if (target.addEventListener) {
                    target.addEventListener(type, callback);
                } else {
                    target.attachEvent('on' + type, callback);
                }
            }
        </script>
    </body>
</html>