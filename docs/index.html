<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!--jQuery 로드-->
        <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
        <!--행정구역 관련 UI CSS 로드-->
        <link rel="stylesheet" href="css/info_window.css">
        <title>Korea_Polygon</title>
    </head>
    <body>
        <!--KAKAO-MAP 로드-->
        <div id="map" style="width:100%;height:100vh;"></div>
        <script
            type="text/javascript"
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2befa4c2ccbf24ac6c3bec24f23abb28"></script>
        <!--ZOOM 컨트롤 버튼 렌더링-->
        <div class="custom_zoomcontrol radius_border">
            <span onclick="zoomIn()">
                <img
                    src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/ico_plus.png"
                    alt="확대">
            </span>
            <span onclick="zoomOut()">
                <img
                    src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/ico_minus.png"
                    alt="축소">
            </span>
        </div>
        <script>
            let map = new kakao
                .maps
                .Map(document.getElementById('map'), {
                    // 지도를 표시할 div
                    center: new kakao
                        .maps
                        .LatLng(37.5642135, 127.0016985), // 초기 지도의 중심좌표
                    level: 12 // 초기 지도의 확대 레벨
                });
            let loca = map.getCenter(); // 초기 지도의 중심좌표 변수
            console.log("초기 지도 줌 레벨 값은 :", map.getLevel());
            // 지도 스크롤 줌 액션 잠금
            map.setZoomable(false);
            // 지도 확대 최대 값 설정
            map.setMaxLevel(12);

            // 지도 스크롤을 2단계 단위로 줌 이벤트 조절
            let map_wheel = document.getElementById('map');
            map_wheel.addEventListener('wheel', event => {
                var level = map.getLevel();
                if (level == 1) 
                    level = 0;
                var step = 2;
                var sign = Math.sign(event.deltaY);

                var changeLevel = level + step * sign;
                map.setLevel(changeLevel);
            });

            // 일반 지도와 스카이뷰로 지도 타입을 전환할 수 있는 지도타입 컨트롤을 생성합니다
            var mapTypeControl = new kakao
                .maps
                .MapTypeControl();
            // 지도에 컨트롤을 추가해야 지도위에 표시됩니다 kakao.maps.ControlPosition은 컨트롤이 표시될 위치를 정의하는데
            // TOPRIGHT는 오른쪽 위를 의미합니다
            map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

            // 초기 지도엔 시도 단위로 폴리곤 렌더링
            $
                .ajax({
                    // crossDomain: true,
                    method: "GET",
                    dataType: "json",
                    // headers: {
                    //     'Access-Control-Allow-Origin': '*'
                    // },
                    url: "https://stories282.shop/geo",
                    data: {
                        lat: loca.getLat(),
                        lot: loca.getLng(),
                        distance: '100',
                        map: 'ctp'
                    },
                    success: function (result) {
                        console.log("Success");
                        // console.log(result);
                    },
                    error: function (e) {
                        console.log('Error');
                        console.log(e);
                    }
                })
                .done(function (params) {
                    console.log(params);
                    let data = params.data;
                    let coordinates = [];
                    let name = '';
                    $.each(data, function (index, val) {
                        coordinates = val.coordinates;
                        name = val.KOR_NM;
                        console.log(coordinates, name);
                        // display(coordinates, name, "CTPRVN");
                    });
                });

            let polygons = []; // 지도 줌 이벤트 시 폴리곤 제거를 위한 배열
            // 폴리곤 렌더링 함수
            function display(coordinates, name, code) {
                let path = [];
                let points = [];
                // console.log(coordinates.length, name);

                $.each(coordinates, function (index, coordinate) {
                    let paths = [];
                    $.each(coordinate, function (index, coord) {
                        let point = new Object();
                        point.x = coord[1];
                        point.y = coord[0];
                        points.push(point);
                        paths.push(new kakao.maps.LatLng(coord[1], coord[0]));
                    });
                    path.push(paths);
                });

                let polygon = new kakao
                    .maps
                    .Polygon({
                        map: map,
                        path: path,
                        strokeWeight: 2,
                        strokeColor: '#004c80',
                        strokeOpacity: 0.8,
                        // strokeStyle: 'dashed',
                        fillColor: '#fff',
                        fillOpacity: 0.3
                    });
                polygons.push(polygon);

                // 다각형에 mouseover 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 변경합니다 지역명을 표시하는 커스텀오버레이를 지도위에
                // 표시합니다
                kakao
                    .maps
                    .event
                    .addListener(polygon, 'mouseover', function () {
                        polygon.setOptions({fillColor: '#09f'});
                    });
                kakao
                    .maps
                    .event
                    .addListener(polygon, 'mouseout', function () {
                        polygon.setOptions({fillColor: '#fff'});
                    });

                display_info(centroid(points), name);
            };
            // 행정구역 관련 UI 렌더링 함수
            function display_info(center, name) {
                // console.log(center, name);

                let customOverlay = new kakao
                    .maps
                    .CustomOverlay({}); // 해당 지역 이름을 표시할 오버레이

                let content = document.createElement('div');
                content.className = 'area';
                content.innerHTML = '<span class="text">' + name + '</span> <span class="text2"' +
                        '> 12,345개 </span> </div>';
                // console.log(content);
                customOverlay.setContent(content);
                customOverlay.setPosition(center);
                customOverlay.setMap(map);
                addEventHandle(content, 'click', onMouseClick(center));

                kakao
                    .maps
                    .event
                    .addListener(map, 'zoom_changed', function () {
                        customOverlay.setMap(null);
                    });
            }

            // 지도에 줌 이벤트가 발생하였을 때
            let markers = [];
            kakao
                .maps
                .event
                .addListener(map, 'zoom_changed', function () {
                    // 지도의 현재 레벨을 얻어옵니다
                    var level = map.getLevel();
                    console.log("현재 지도 줌 레벨 값은 :", level);

                    // 레벨이 12 인경우 시도 단위로 폴리곤 렌더링
                    // if (level == 12) {
                    //     deletePolygon(polygons);
                    //     deleteMarker(markers);
                    //     $
                    //         .ajax(
                    //             {url: "https://raw.githubusercontent.com/Team-CONO/FrontEnd-MAP/main/json/CTPRVN.json", method: "GET", dataType: "json"}
                    //         )
                    //         .done(function (params) {
                    //             let data = params.features;
                    //             let coordinates = [];
                    //             let name = '';
                    //             $.each(data, function (index, val) {
                    //                 coordinates = val.geometry.coordinates;
                    //                 name = val.properties.CTP_KOR_NM;
                    //                 // console.log(coordinates, name);
                    //                 display(coordinates, name, "CTPRVN");
                    //             });
                    //         });
                    // }
                    // // 레벨이 8이상 10이하 인경우 시군구 단위로 폴리곤 렌더링
                    // if (level >= 8 && level <= 10) {
                    //     deletePolygon(polygons);
                    //     deleteMarker(markers);
                    //     $
                    //         .ajax(
                    //             {url: "https://raw.githubusercontent.com/Team-CONO/FrontEnd-MAP/main/json/SIG.json", method: "GET", dataType: "json"}
                    //         )
                    //         .done(function (params) {
                    //             let data = params.features;
                    //             let coordinates = [];
                    //             let name = '';
                    //             $.each(data, function (index, val) {
                    //                 coordinates = val.geometry.coordinates;
                    //                 name = val.properties.SIG_KOR_NM;
                    //                 // console.log(coordinates, name);
                    //                 display(coordinates, name, "SIG");
                    //             });
                    //         });
                    // }
                    // // 레벨이 6 인경우 읍면동 단위로 폴리곤 렌더링
                    // if (level == 6) {
                    //     deletePolygon(polygons);
                    //     deleteMarker(markers);
                    //     $
                    //         .ajax(
                    //             {url: "https://raw.githubusercontent.com/Team-CONO/FrontEnd-MAP/main/json/EMD.json", method: "GET", dataType: "json"}
                    //         )
                    //         .done(function (params) {
                    //             let data = params.features;
                    //             let coordinates = [];
                    //             let name = '';
                    //             $.each(data, function (index, val) {
                    //                 coordinates = val.geometry.coordinates;
                    //                 name = val.properties.EMD_KOR_NM;
                    //                 // console.log(coordinates, name);
                    //                 display(coordinates, name, "EMD");
                    //             });
                    //         });
                    // }
                    // // 레벨이 4 인경우 거리 단위 이므로 해당 지역 관련 마커 렌더링
                    // if (level == 4) {
                    //     deletePolygon(polygons);
                    //     deleteMarker(markers);
                    //     $
                    //         .ajax({
                    //             url: "https://raw.githubusercontent.com/Team-CONO/FrontEnd-MAP/main/json/starbucks-e" +
                    //                     "dited.json",
                    //             method: "GET",
                    //             dataType: "json"
                    //         })
                    //         .done(function (data) {
                    //             markers = $(data).map(function (i, value) {
                    //                 return new kakao
                    //                     .maps
                    //                     .Marker({
                    //                         position: new kakao
                    //                             .maps
                    //                             .LatLng(value.lat, value.lot)
                    //                     });
                    //             });
                    //             for (var index = 0; index < markers.length; index++) {
                    //                 markers[index].setMap(map);
                    //                 //마커에 표시할 인포윈도우를 생성합니다
                    //                 var infowindow = new kakao
                    //                     .maps
                    //                     .InfoWindow({
                    //                         content: "스타벅스 " + data[index].s_name // 인포윈도우에 표시할 내용
                    //                     });
                    //                 // 마커에 mouseover 이벤트와 mouseout 이벤트를 등록합니다 이벤트 리스너로는 클로저를 만들어 등록합니다 for문에서 클로저를
                    //                 // 만들어 주지 않으면 마지막 마커에만 이벤트가 등록됩니다
                    //                 kakao
                    //                     .maps
                    //                     .event
                    //                     .addListener(
                    //                         markers[index],
                    //                         'mouseover',
                    //                         makeOverListener(map, markers[index], infowindow)
                    //                     );
                    //                 kakao
                    //                     .maps
                    //                     .event
                    //                     .addListener(markers[index], 'mouseout', makeOutListener(infowindow));
                    //                 kakao
                    //                     .maps
                    //                     .event
                    //                     .addListener(markers[index], 'click', makeClickListener(data[index].s_name));
                    //             }
                    //         });
                    // }
                });

            // 인포윈도우를 표시하는 클로저를 만드는 함수입니다
            function makeOverListener(map, marker, infowindow) {
                return function () {
                    infowindow.open(map, marker);
                };
            }
            // 인포윈도우를 닫는 클로저를 만드는 함수입니다
            function makeOutListener(infowindow) {
                return function () {
                    infowindow.close();
                };
            }
            // 인포윈도우 클릭하는 클로저를 만드는 함수
            function makeClickListener(title) {
                return function () {
                    console.log('클릭된 지점은 ' + title + ' 입니다.');
                }
            }

            // 지도 확대, 축소 컨트롤에서 확대 버튼을 누르면 호출되어 지도를 확대하는 함수입니다
            function zoomIn() {
                map.setLevel(map.getLevel() - 2);
            }
            // 지도 확대, 축소 컨트롤에서 축소 버튼을 누르면 호출되어 지도를 축소하는 함수입니다
            function zoomOut() {
                if (map.getLevel() == 1) {
                    map.setLevel(2);
                } else {
                    map.setLevel(map.getLevel() + 2);
                }
            }

            // 지도 줌 값에 따른 폴리곤 제거
            function deletePolygon(polygons) {
                for (let index = 0; index < polygons.length; index++) {
                    polygons[index].setMap(null);
                }
            }
            // 지도 줌 값에 따른 마커 제거
            function deleteMarker(markers) {
                for (let index = 0; index < markers.length; index++) {
                    markers[index].setMap(null);
                }
            }

            // 폴리곤 중심좌표를 구하는 centroid 알고리즘 함수
            function centroid(points) {
                let i,
                    j,
                    len,
                    p1,
                    p2,
                    f,
                    area,
                    x,
                    y;

                area = x = y = 0;

                for (i = 0, len = points.length, j = len - 1; i < len; j = i++) {
                    p1 = points[i];
                    p2 = points[j];

                    f = p1.y * p2.x - p2.y * p1.x;
                    x += (p1.x + p2.x) * f;
                    y += (p1.y + p2.y) * f;
                    area += f * 3;
                }

                return new kakao
                    .maps
                    .LatLng(x / area, y / area);
            }

            // 행정구역 UI를 클릭 했을 때 호출되는 핸들러 입니다
            function onMouseClick(center) {
                return function () {
                    // console.log('click'); UI 클릭 시 지도 줌 이벤트 활성
                    if (map.getLevel() == 10) {
                        map.setLevel(map.getLevel() - 4, {
                            anchor: center,
                            animate: {
                                duration: 350
                            }
                        });
                        deletePolygon(polygons);
                    } else {
                        map.setLevel(map.getLevel() - 2, {
                            anchor: center,
                            animate: {
                                duration: 350
                            }
                        });
                        deletePolygon(polygons);
                    }
                };
            }
            // target node에 이벤트 핸들러를 등록하는 함수힙니다
            function addEventHandle(target, type, callback) {
                if (target.addEventListener) {
                    target.addEventListener(type, callback);
                } else {
                    target.attachEvent('on' + type, callback);
                }
            }
        </script>
    </body>
</html>