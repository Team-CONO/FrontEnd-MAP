<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=Edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!--jQuery 로드-->
        <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
        <!--지도 UI CSS 로드-->
        <link rel="stylesheet" href="css/map.css">
        <title>Korea_Polygon</title>
    </head>
    <body>
        <!--KAKAO-MAP 로드-->
        <div id="map" style="width:100%;height:100vh;"></div>
        <script
            src="//dapi.kakao.com/v2/maps/sdk.js?appkey=2befa4c2ccbf24ac6c3bec24f23abb28"></script>
        <!--ZOOM 컨트롤 버튼 렌더링-->
        <div class="custom_zoomcontrol radius_border">
            <span onclick="zoomIn()">
                <img
                    src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/ico_plus.png"
                    alt="확대">
            </span>
            <span onclick="zoomOut()">
                <img
                    src="https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/ico_minus.png"
                    alt="축소">
            </span>
        </div>
        <script>
            let map = new kakao
                .maps
                .Map(document.getElementById('map'), {
                    // 지도를 표시할 div
                    center: new kakao
                        .maps
                        .LatLng(37.5642135, 127.0016985), // 초기 지도의 중심좌표
                    level: 8, // 초기 지도의 확대 레벨
                    disableDoubleClickZoom: true, // 지도에 더블클릭 방지
                    scrollwheel: false // 지도에 스크롤 및 터치에 따른 확대 방지
                });
            // console.log("초기 지도 줌 레벨 값은 :", map.getLevel());
            // 지도 축소 최대 값 설정
            map.setMaxLevel(12);
            // 지도의 중심좌표 변수
            let mapCenter = map.getCenter();
            // 지도의 타입 변수
            let mapType;
            // 지도의 줌 레벨 변수
            let mapLevel;

            // 지도에 스크롤 줌 이벤트 값을 각각 숫자 2 단위로 규정
            let mapWheel = document.getElementById('map');
            mapWheel.addEventListener('wheel', event => {
                mapLevel = map.getLevel();
                if (mapLevel == 1) 
                    mapLevel = 0;
                let step = 2;
                let sign = Math.sign(event.deltaY);

                let changeLevel = mapLevel + step * sign;
                map.setLevel(changeLevel);
            });

            // 일반 지도와 스카이뷰로 지도 타입을 전환할 수 있는 지도타입 컨트롤을 생성합니다
            var mapTypeControl = new kakao
                .maps
                .MapTypeControl();
            // 지도에 컨트롤을 추가해야 지도위에 표시됩니다 kakao.maps.ControlPosition은 컨트롤이 표시될 위치를 정의하는데
            // TOPRIGHT는 오른쪽 위를 의미합니다
            map.addControl(mapTypeControl, kakao.maps.ControlPosition.TOPRIGHT);

            // 초기 지도는 화면 중심으로 시군구 단위로 폴리곤 렌더링
            mapUnit(mapCenter, 'sig');

            // 지도에 줌 이벤트가 발생하였을 때
            let markers = [];
            kakao
                .maps
                .event
                .addListener(map, 'zoom_changed', function () {
                    // 지도의 현재 중심좌표를 얻어옵니다
                    mapCenter = map.getCenter();
                    // 지도의 현재 줌 레벨값을 얻어옵니다
                    mapLevel = map.getLevel();
                    // console.log("현재 지도 줌 레벨 값은 :", mapLevel);

                    // 레벨이 10 이상인 경우 시도 단위로 폴리곤 렌더링
                    if (mapLevel >= 10) {
                        deletePolygon(polygons);
                        deleteMarker(markers);
                        mapUnit(mapCenter, 'ctp');
                    }
                    // 레벨이 8인 경우 시군구 단위로 폴리곤 렌더링
                    if (mapLevel == 8) {
                        deletePolygon(polygons);
                        deleteMarker(markers);
                        mapUnit(mapCenter, 'sig');
                    }
                    // 레벨이 6 인경우 읍면동 단위로 폴리곤 렌더링
                    if (mapLevel == 6) {
                        deletePolygon(polygons);
                        deleteMarker(markers);
                        mapUnit(mapCenter, 'emd');
                    }
                    //레벨이 4 인경우 거리 단위 이므로 해당 지역 관련 마커 렌더링
                    if (mapLevel == 4) {
                        deletePolygon(polygons);
                        deleteMarker(markers);
                    }
                });

            // 지도에 드래그 이벤트가 발생하였을 때
            kakao
                .maps
                .event
                .addListener(map, 'dragend', function () {
                    mapCenter = map.getCenter();
                    mapLevel = map.getLevel();

                    // 드래그 이벤트로 인한 새로운 지도 모습에 중심좌표를 기점으로 새 폴리곤 및 UI 렌더링
                    if (mapLevel > 4) {
                        deletePolygon(polygons);
                        mapUnit(mapCenter, mapType);
                    }
                });

            // 지도 타입에 따른 관리자 페이지 API 'geo' 호출 함수
            function mapUnit(mapCenter, map_type) {
                // 사용자 지도 화면 중심 좌표와 검색 범위를 API 요청값으로 넘겨 폴리곤 그리고 UI 렌더링 함수에 이용
                if (map_type == "ctp") {
                    $
                        .ajax({
                            method: "GET",
                            dataType: "json",
                            url: "https://foilemap.co.kr/geo",
                            data: {
                                lat: mapCenter.getLat(),
                                lot: mapCenter.getLng(),
                                distance: '200',
                                map: map_type
                            },
                            error: function (e) {
                                console.log('Error:', e);
                            }
                        })
                        .done(function (params) {
                            // console.log(params);
                            let data = params.data;
                            let coordinates = [];
                            let getData = [];
                            let getCD = [];
                            $.each(data, function (index, val) {
                                mapType = val.map_type;
                                coordinates = val.coordinates;
                                getData.push({
                                    center: [
                                        val.center_lat, val.center_lot
                                    ],
                                    name: val.KOR_NM,
                                    cd: val.CD
                                });
                                getCD.push(val.CD);
                                // console.log(coordinates);
                                display(coordinates);
                            });
                            // console.log(getData);
                            mapCnt(getCD, getData);
                        });
                } else if (map_type == "sig") {
                    $
                        .ajax({
                            method: "GET",
                            dataType: "json",
                            url: "https://foilemap.co.kr/geo",
                            data: {
                                lat: mapCenter.getLat(),
                                lot: mapCenter.getLng(),
                                distance: '20',
                                map: map_type
                            },
                            error: function (e) {
                                console.log('Error:', e);
                            }
                        })
                        .done(function (params) {
                            // console.log(params);
                            let data = params.data;
                            let coordinates = [];
                            let getData = [];
                            let getCD = [];
                            $.each(data, function (index, val) {
                                mapType = val.map_type;
                                coordinates = val.coordinates;
                                getData.push({
                                    center: [
                                        val.center_lat, val.center_lot
                                    ],
                                    name: val.KOR_NM,
                                    cd: val.CD
                                });
                                getCD.push(val.CD);
                                // console.log(coordinates);
                                display(coordinates);
                            });
                            // console.log(getData);
                            mapCnt(getCD, getData);
                        });
                } else if (map_type == "emd") {
                    $
                        .ajax({
                            method: "GET",
                            dataType: "json",
                            url: "https://foilemap.co.kr/geo",
                            data: {
                                lat: mapCenter.getLat(),
                                lot: mapCenter.getLng(),
                                distance: '5',
                                map: map_type
                            },
                            error: function (e) {
                                console.log('Error:', e);
                            }
                        })
                        .done(function (params) {
                            // console.log(params);
                            let data = params.data;
                            let coordinates = [];
                            let getData = [];
                            let getCD = [];
                            $.each(data, function (index, val) {
                                mapType = val.map_type;
                                coordinates = val.coordinates;
                                getData.push({
                                    center: [
                                        val.center_lat, val.center_lot
                                    ],
                                    name: val.KOR_NM,
                                    cd: val.CD
                                });
                                getCD.push(val.CD);
                                // console.log(coordinates);
                                display(coordinates);
                            });
                            // console.log(getData);
                            mapCnt(getCD, getData);
                        });
                }
            }

            let polygons = []; // 지도 줌 이벤트 시 폴리곤 제거를 위한 배열
            // 폴리곤 렌더링 함수
            function display(coordinates) {
                let path = [];
                // console.log(coordinates.length);

                $.each(coordinates, function (index, coordinate) {
                    let paths = [];
                    $.each(coordinate, function (index, coord) {
                        paths.push(new kakao.maps.LatLng(coord.lat, coord.lot));
                    });
                    path.push(paths);
                });

                let polygon = new kakao
                    .maps
                    .Polygon({
                        map: map,
                        path: path,
                        strokeWeight: 2,
                        strokeColor: '#004c80',
                        strokeOpacity: 0.8,
                        // strokeStyle: 'dashed',
                        fillColor: '#fff',
                        fillOpacity: 0.3
                    });
                polygons.push(polygon);

                // 다각형에 mouseover 이벤트를 등록하고 이벤트가 발생하면 폴리곤의 채움색을 변경합니다 지역명을 표시하는 커스텀오버레이를 지도위에
                // 표시합니다
                kakao
                    .maps
                    .event
                    .addListener(polygon, 'mouseover', function () {
                        polygon.setOptions({fillColor: '#09f'});
                    });
                kakao
                    .maps
                    .event
                    .addListener(polygon, 'mouseout', function () {
                        polygon.setOptions({fillColor: '#fff'});
                    });
            };

            // 행정구역 매물 관련 API 'forsale' 호출 함수
            function mapCnt(getCD, getData) {
                // console.log(getCD);
                let CDstring = getCD.join(','); // CD 배열을 문자열로 변환
                $
                    .ajax({
                        method: "POST",
                        dataType: "json",
                        url: "https://foilemap.co.kr/forsale/map",
                        contentType: "application/json",
                        data: JSON.stringify({
                            "lat": mapCenter.getLat(),
                            "lot": mapCenter.getLng(),
                            "distance": 100,
                            "geoCDS": CDstring,
                            "map": mapType,
                            "page": 0,
                            "printSize": 10
                        }),
                        error: function (e) {
                            console.log('Error...', e);
                        }
                    })
                    .done(function (params) {
                        console.log(params);
                        let arry = [];
                        $.each(params.data, function (index, val) {
                            // console.log(val);
                            // 지도의 타입에 따라 해당 매물의 'CD' 값을 구분지어 받음
                            if (mapType == "ctp") {
                                arry.push({cnt: val.cnt, type: val.addr_CD_1});
                            } else if (mapType == "sig") {
                                arry.push({cnt: val.cnt, type: val.addr_CD_2});
                            } else if (mapType == "emd") {
                                arry.push({cnt: val.cnt, type: val.addr_CD_3});
                            }
                        });

                        $.each(getData, function (index, val) {
                            // console.log(val);
                            arry.forEach(element => {
                                // 매물 cnt 값이 있으며 현재 렌더링 된 폴리곤 범위에 속한 구역이라면
                                if (element.type == val.cd) {
                                    displayInfo(
                                        new kakao.maps.LatLng(val.center[0], val.center[1]),
                                        val.name,
                                        element.cnt
                                    );
                                } else {
                                    displayInfo(new kakao.maps.LatLng(val.center[0], val.center[1]), val.name, 0)
                                }
                            });
                        });
                    });
            }

            // 행정구역 UI 렌더링 함수
            function displayInfo(center, name, cnt) {
                // console.log(center, name);
                let customOverlay = new kakao
                    .maps
                    .CustomOverlay({}); // 해당 지역 관련 UI를 표시할 오버레이

                let content = document.createElement('div');
                content.className = 'area';
                content.innerHTML = '<span class="text">' + name +
                        '</span><span class="text2">' + cnt + '개</span></div>';
                // console.log(content);
                customOverlay.setContent(content);
                customOverlay.setPosition(center);
                customOverlay.setMap(map);
                addEventHandle(content, 'click', onMouseClick(center));

                // 줌 이벤트, 드래그 이벤트가 있을 때 마다 기존의 UI는 제거
                kakao
                    .maps
                    .event
                    .addListener(map, 'zoom_changed', function () {
                        customOverlay.setMap(null);
                    });
                kakao
                    .maps
                    .event
                    .addListener(map, 'dragend', function () {
                        customOverlay.setMap(null);
                    });
            }

            // 지도 확대, 축소 컨트롤에서 확대 버튼을 누르면 호출되어 지도를 확대하는 함수입니다
            function zoomIn() {
                map.setLevel(map.getLevel() - 2);
            }
            // 지도 확대, 축소 컨트롤에서 축소 버튼을 누르면 호출되어 지도를 축소하는 함수입니다
            function zoomOut() {
                if (map.getLevel() == 1) {
                    map.setLevel(2);
                } else {
                    map.setLevel(map.getLevel() + 2);
                }
            }

            // 지도 줌 이벤트에 따른 기존 폴리곤 제거
            function deletePolygon(polygons) {
                for (let index = 0; index < polygons.length; index++) {
                    polygons[index].setMap(null);
                }
            }
            // 지도 줌 이벤트에 따른 기존 마커 제거
            function deleteMarker(markers) {
                for (let index = 0; index < markers.length; index++) {
                    markers[index].setMap(null);
                }
            }

            // 마커의 인포윈도우를 표시하는 클로저를 만드는 함수입니다
            function makeOverListener(map, marker, infowindow) {
                return function () {
                    infowindow.open(map, marker);
                };
            }
            // 마커의 인포윈도우를 닫는 클로저를 만드는 함수입니다
            function makeOutListener(infowindow) {
                return function () {
                    infowindow.close();
                };
            }
            // 마커의 인포윈도우를 클릭하는 클로저를 만드는 함수
            function makeClickListener(title) {
                return function () {
                    console.log('클릭된 지점은 ' + title + ' 입니다.');
                }
            }

            // 행정구역 UI를 클릭 했을 때 호출되는 핸들러 입니다
            function onMouseClick(center) {
                return function () {
                    // console.log('click'); 
                    
                    // UI 클릭 시 지도 줌 이벤트 활성
                    if (map.getLevel() == 10) {
                        map.setLevel(map.getLevel() - 4, {
                            anchor: center,
                            animate: {
                                duration: 350
                            }
                        });
                        deletePolygon(polygons);
                    } else {
                        map.setLevel(map.getLevel() - 2, {
                            anchor: center,
                            animate: {
                                duration: 350
                            }
                        });
                        deletePolygon(polygons);
                    }
                };
            }
            // target node에 이벤트 핸들러를 등록하는 함수힙니다
            function addEventHandle(target, type, callback) {
                if (target.addEventListener) {
                    target.addEventListener(type, callback);
                } else {
                    target.attachEvent('on' + type, callback);
                }
            }
        </script>
    </body>
</html>